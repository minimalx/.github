name: "Check balena.yml version bump"
description: "Ensures balena.yml version is bumped according to semantic versioning."

inputs:
  base-sha:
    required: true
  head-sha:
    required: true
  file:
    required: false
    default: "balena.yml"

outputs:
  tag:
    description: "Generated tag TCU_STACK_v<version>"
    value: ${{ steps.extract-version.outputs.tag }}

runs:
  using: "composite"
  steps:

    - name: Run version bump check
      id: version-check
      shell: bash
      run: |
        # Temporarily disable 'exit on error' so we can capture the script's output
        set +e
        OUTPUT=$(python "${GITHUB_ACTION_PATH}/scripts/check_version_bump.py" \
          --base "${{ inputs.base-sha }}" \
          --head "${{ inputs.head-sha }}" \
          --file "${{ inputs.file }}")
        STATUS=$?
        # Re-enable 'exit on error' for the rest of the script
        set -e

        # Always show the Python output in the logs
        echo "$OUTPUT"

        # If the Python script failed, propagate its exit code and stop here
        if [ "$STATUS" -ne 0 ]; then
          exit "$STATUS"
        fi

        # Only reach here if Python exited 0 â†’ safe to parse VERSION_OUTPUT
        VERSION=$(echo "$OUTPUT" | sed -n 's/^VERSION_OUTPUT=//p' | tail -n 1)

        if [ -z "$VERSION" ]; then
          echo "::error::Failed to extract version from script output"
          exit 1
        fi

        echo "VERSION=$VERSION" >> "$GITHUB_ENV"

    - name: Format tag output
      id: extract-version
      shell: bash
      run: |
        TAG="TCU_STACK_v${VERSION}"
        echo "tag=$TAG" >> "$GITHUB_OUTPUT"
